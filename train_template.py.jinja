#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
YOLOæ¨¡å‹è®­ç»ƒè„šæœ¬
è‡ªåŠ¨ç”Ÿæˆäºæ•°æ®é›†åˆ’åˆ†æ—¶
"""

import os
import sys
import argparse

# æ·»åŠ ultralyticsåˆ°è·¯å¾„
try:
    from ultralytics import YOLO
except ImportError:
    print("è¯·å®‰è£…ultralytics: pip install ultralytics")
    sys.exit(1)


def find_best_model():
    """æŸ¥æ‰¾æœ€ä½³æ¨¡å‹æ–‡ä»¶"""
    best_model_path = 'runs/detect/train/weights/best.pt'
    
    if os.path.exists(best_model_path):
        return best_model_path
    return None


def train():
    """æ‰§è¡ŒYOLOæ¨¡å‹è®­ç»ƒ"""
    # è·å–å½“å‰è„šæœ¬æ‰€åœ¨ç›®å½•
    current_dir = os.path.dirname(os.path.abspath(__file__))
    
    # é…ç½®æ–‡ä»¶è·¯å¾„ï¼ˆtrain.ymlä½äºåŒä¸€ç›®å½•ä¸‹ï¼‰
    data_yaml = os.path.join(current_dir, "train.yml")
    
    # æ£€æŸ¥é…ç½®æ–‡ä»¶æ˜¯å¦å­˜åœ¨
    if not os.path.exists(data_yaml):
        raise FileNotFoundError(f"é…ç½®æ–‡ä»¶ä¸å­˜åœ¨: {data_yaml}")
    
    # åŠ è½½YOLOæ¨¡å‹ï¼ˆä½¿ç”¨é¢„è®­ç»ƒæ¨¡å‹ï¼‰
    model = YOLO('yolov8n.pt')  # å¯ä»¥æ ¹æ®éœ€è¦ä¿®æ”¹æ¨¡å‹å¤§å°: yolov8n/s/m/l/x
    
    # è®­ç»ƒå‚æ•°é…ç½®
    train_args = {
        'data': data_yaml,
        'epochs': 100,
        'imgsz': 640,
        'batch': 16,
        'name': 'yolo_train',
        'project': os.path.join(current_dir, 'runs'),
        'patience': 50,
        'save': True,
        'device': 0,  # ä½¿ç”¨GPU 0ï¼Œå¦‚æœæ²¡æœ‰GPUåˆ™æ”¹ä¸º 'cpu'
    }
    
    {% if custom_params %}
    # ç”¨æˆ·è‡ªå®šä¹‰å‚æ•°ï¼ˆç›´æ¥åˆå¹¶åˆ°train_argsä¸­ï¼‰
    custom_params = {
        {% for key, value in custom_params.items() %}
        '{{ key }}': {{ value }},
        {% endfor %}
    }
    train_args.update(custom_params)
    {% endif %}
    
    # æ‰“å°è®­ç»ƒå‚æ•°
    print("=" * 50)
    print("è®­ç»ƒå‚æ•°é…ç½®:")
    for key, value in train_args.items():
        print(f"  {key}: {value}")
    print("=" * 50)
    
    # å¼€å§‹è®­ç»ƒ
    try:
        results = model.train(**train_args)
        print("\nè®­ç»ƒå®Œæˆ!")
        print(f"æœ€ä½³æ¨¡å‹ä¿å­˜åœ¨: {model.trainer.best}")
        return results
    except Exception as e:
        print(f"è®­ç»ƒè¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯: {e}")
        import traceback
        traceback.print_exc()
        return None


def val():
    """æ‰§è¡ŒYOLOæ¨¡å‹éªŒè¯"""
    # è·å–å½“å‰è„šæœ¬æ‰€åœ¨ç›®å½•
    current_dir = os.path.dirname(os.path.abspath(__file__))
    
    # é…ç½®æ–‡ä»¶è·¯å¾„
    data_yaml = os.path.join(current_dir, "train.yml")
    
    # æ£€æŸ¥é…ç½®æ–‡ä»¶æ˜¯å¦å­˜åœ¨
    if not os.path.exists(data_yaml):
        print(f"é…ç½®æ–‡ä»¶ä¸å­˜åœ¨: {data_yaml}")
        return None
    
    # æŸ¥æ‰¾æœ€ä½³æ¨¡å‹æ–‡ä»¶
    best_model_path = os.path.join(current_dir, 'runs/detect/yolo_train/weights/best.pt')
    if not os.path.exists(best_model_path):
        # å°è¯•é»˜è®¤è·¯å¾„
        best_model_path = 'runs/detect/train/weights/best.pt'
        if not os.path.exists(best_model_path):
            print("æœªæ‰¾åˆ°æœ€ä½³æ¨¡å‹ï¼Œè¯·å…ˆè®­ç»ƒæ¨¡å‹")
            return None
    
    print(f"ä½¿ç”¨æœ€ä½³æ¨¡å‹: {best_model_path}")
    model = YOLO(best_model_path)
    
    # éªŒè¯å‚æ•°
    val_args = {
        'data': data_yaml,
    }
    
    print(f"å¼€å§‹éªŒè¯æ¨¡å‹ï¼Œå‚æ•°: {val_args}")
    
    # å¼€å§‹éªŒè¯
    try:
        results = model.val(**val_args)
        print("éªŒè¯å®Œæˆ!")
        
        # è®¡ç®—ç™¾åˆ†æ¯”æŒ‡æ ‡
        map_percent = results.box.map * 100
        map50_percent = results.box.map50 * 100
        map75_percent = results.box.map75 * 100
        precision_percent = results.box.p.mean() * 100
        recall_percent = results.box.r.mean() * 100
        f1_percent = results.box.f1.mean() * 100
        
        # æ‰“å°å…³é”®æŒ‡æ ‡ï¼ˆä»¥ç™¾åˆ†æ¯”æ˜¾ç¤ºï¼‰
        print("\n" + "=" * 50)
        print("éªŒè¯ç»“æœ")
        print("=" * 50)
        print(f"mAP: {map_percent:.2f}%")
        print(f"mAP50: {map50_percent:.2f}%")
        print(f"mAP75: {map75_percent:.2f}%")
        print(f"Precision: {precision_percent:.2f}%")
        print(f"Recall: {recall_percent:.2f}%")
        print(f"F1-Score: {f1_percent:.2f}%")
        print("=" * 50)
        
        # æ¨¡å‹è´¨é‡è¯„ä¼°å’Œæ”¹è¿›å»ºè®®ï¼ˆåŸºäºmAPæŒ‡æ ‡è¯„ä¼°ï¼‰
        print("\n" + "=" * 50)
        print("æ¨¡å‹è´¨é‡è¯„ä¼°")
        print("=" * 50)
        if map_percent >= 80:
            print("ğŸŸ¢ æ¨¡å‹è´¨é‡ä¼˜ç§€ (mAP >= 80%)")
        elif map_percent >= 60:
            print("ğŸŸ¡ æ¨¡å‹è´¨é‡è‰¯å¥½ (60% <= mAP < 80%)")
        elif map_percent >= 40:
            print("ğŸŸ  æ¨¡å‹è´¨é‡ä¸€èˆ¬ (40% <= mAP < 60%)")
        else:
            print("ğŸ”´ æ¨¡å‹è´¨é‡è¾ƒå·® (mAP < 40%)")
            
        # æ ¹æ®mAP50å’ŒmAP75çš„å·®å¼‚æä¾›é¢å¤–è¯„ä¼°
        if map50_percent - map75_percent > 20:
            print("\nâš ï¸  æ³¨æ„: mAP50ä¸mAP75å·®è·è¾ƒå¤§ï¼Œè¯´æ˜æ¨¡å‹åœ¨å®šä½ç²¾åº¦ä¸Šå¯èƒ½å­˜åœ¨é—®é¢˜")
            
        if map_percent < 60:
            print("\nğŸ’¡ æ”¹è¿›å»ºè®®:")
            print("1. å¢åŠ è®­ç»ƒè½®æ•° (epochs)")
            print("2. è°ƒæ•´å­¦ä¹ ç‡")
            print("3. å¢åŠ è®­ç»ƒæ•°æ®é‡å’Œå¤šæ ·æ€§")
            print("4. å°è¯•ä½¿ç”¨æ›´å¤§çš„æ¨¡å‹")
            print("5. æ£€æŸ¥æ ‡æ³¨è´¨é‡")
            print("6. è°ƒæ•´æ•°æ®å¢å¼ºç­–ç•¥")
            
        if precision_percent > 90 and recall_percent < 70:
            print("\nâš ï¸  æ³¨æ„: ç²¾åº¦è¿‡é«˜ä½†å¬å›ç‡è¾ƒä½ï¼Œå¯èƒ½å­˜åœ¨è¿‡æ‹Ÿåˆæˆ–æ¼æ£€é—®é¢˜")
        elif recall_percent > 90 and precision_percent < 70:
            print("\nâš ï¸  æ³¨æ„: å¬å›ç‡è¿‡é«˜ä½†ç²¾åº¦è¾ƒä½ï¼Œå¯èƒ½å­˜åœ¨è¿‡å¤šè¯¯æ£€")
        
        print("=" * 50)
        return results
            
    except Exception as e:
        print(f"éªŒè¯è¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯: {e}")
        import traceback
        traceback.print_exc()
        return None


def benchmark():
    """æ‰§è¡ŒYOLOæ¨¡å‹åŸºå‡†æµ‹è¯•"""
    # è·å–å½“å‰è„šæœ¬æ‰€åœ¨ç›®å½•
    current_dir = os.path.dirname(os.path.abspath(__file__))
    
    # æŸ¥æ‰¾æœ€ä½³æ¨¡å‹æ–‡ä»¶
    best_model_path = os.path.join(current_dir, 'runs/detect/yolo_train/weights/best.pt')
    if not os.path.exists(best_model_path):
        # å°è¯•é»˜è®¤è·¯å¾„
        best_model_path = 'runs/detect/train/weights/best.pt'
        if not os.path.exists(best_model_path):
            print("æœªæ‰¾åˆ°æœ€ä½³æ¨¡å‹ï¼Œè¯·å…ˆè®­ç»ƒæ¨¡å‹")
            return None
    
    print(f"ä½¿ç”¨æœ€ä½³æ¨¡å‹: {best_model_path}")
    model = YOLO(best_model_path)
    
    # åŸºå‡†æµ‹è¯•å‚æ•°
    bench_args = {
        'imgsz': 640,  # é»˜è®¤å›¾åƒå°ºå¯¸
        'device': 0,   # é»˜è®¤è®¾å¤‡ä¸ºGPU
    }
    
    print(f"å¼€å§‹åŸºå‡†æµ‹è¯•ï¼Œå‚æ•°: {bench_args}")
    
    # å¼€å§‹åŸºå‡†æµ‹è¯•
    try:
        results = model.benchmark(**bench_args)
        print("åŸºå‡†æµ‹è¯•å®Œæˆ!")
        
        # æ‰“å°å…³é”®æŒ‡æ ‡
        print("\n" + "=" * 50)
        print("åŸºå‡†æµ‹è¯•ç»“æœ")
        print("=" * 50)
        if hasattr(results, 'speed') and results.speed:
            print(f"æ¨ç†é€Ÿåº¦: {results.speed:.2f} ms/img")
        if hasattr(results, 'fps') and results.fps:
            print(f"å¸§ç‡: {results.fps:.2f} FPS")
        print("=" * 50)
            
        # æ€§èƒ½è¯„ä¼°å’Œæ”¹è¿›å»ºè®®
        print("\n" + "=" * 50)
        print("æ€§èƒ½è¯„ä¼°")
        print("=" * 50)
        if hasattr(results, 'speed'):
            if results.speed <= 20:
                print("ğŸŸ¢ æ¨ç†é€Ÿåº¦ä¼˜ç§€ (<= 20ms/img)")
            elif results.speed <= 50:
                print("ğŸŸ¡ æ¨ç†é€Ÿåº¦è‰¯å¥½ (20-50ms/img)")
            elif results.speed <= 100:
                print("ğŸŸ  æ¨ç†é€Ÿåº¦ä¸€èˆ¬ (50-100ms/img)")
            else:
                print("ğŸ”´ æ¨ç†é€Ÿåº¦è¾ƒæ…¢ (> 100ms/img)")
                
            if results.speed > 50:
                print("\nğŸ’¡ æ€§èƒ½ä¼˜åŒ–å»ºè®®:")
                print("1. ä½¿ç”¨æ¨¡å‹é‡åŒ–æŠ€æœ¯")
                print("2. å°è¯•æ›´å°çš„æ¨¡å‹ç‰ˆæœ¬")
                print("3. ä½¿ç”¨æ¨¡å‹å‰ªæ")
                print("4. è€ƒè™‘ä½¿ç”¨TensorRTç­‰æ¨ç†ä¼˜åŒ–å·¥å…·")
                print("5. é™ä½è¾“å…¥å›¾åƒå°ºå¯¸")
        print("=" * 50)
        return results
                
    except Exception as e:
        print(f"åŸºå‡†æµ‹è¯•è¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯: {e}")
        import traceback
        traceback.print_exc()
        return None


def main():
    """ä¸»å‡½æ•°"""
    parser = argparse.ArgumentParser(description='YOLOæ¨¡å‹è®­ç»ƒã€éªŒè¯å’ŒåŸºå‡†æµ‹è¯•è„šæœ¬')
    parser.add_argument('action', choices=['train', 'val', 'benchmark'], 
                        help='æ‰§è¡Œçš„æ“ä½œ: train(è®­ç»ƒ), val(éªŒè¯), benchmark(åŸºå‡†æµ‹è¯•)')
    
    args = parser.parse_args()
    
    if args.action == 'train':
        train()
    elif args.action == 'val':
        val()
    elif args.action == 'benchmark':
        benchmark()


if __name__ == '__main__':
    main()
